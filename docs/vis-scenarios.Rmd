---
title: "Hospitalization scenarios"
#author: "Michael Garber"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#Load data and packages
#Feb 13 2022 update using long-form data.
library(here)
library(mapview)
library(tidyverse)
library(viridis)
library(viridisLite)
library(leaflet)
library(leaflet.extras)
source(here("scripts","read-ratios-diffs-maren.R"))#load measures
source(here("scripts","link-zcta-hosp-data.R"))#load linked files

#Data created here:
#heat-hosp-california/scripts/link-zcta-hosp-data.R
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#Define mapview functions
scenario_list = hosp_both_long %>% 
  distinct(scenario) %>% 
  pull()

length(scenario_list)
hosp_ratio_long
scenario_list[1]
#Set basemaps
mapviewOptions(
  basemaps = c("CartoDB.Positron","CartoDB.DarkMatter"))
mv_fun = function(df, ratio_diff_value, scenario_value){
  #Mapview seems to prefer when the data are filtered
  #before the mapview. Otherwise, sometimes there are issues with
  #legends not working.
  #Recall mapview doesn't like factors, so use the character version instead
  #https://github.com/r-spatial/mapview/issues/425
  #So first create df.
  
  #Okay, what seems to work the best is to begin with the zcta geometry,
  #left join the measures, and then mapview, so:
  
  df_measures= df %>% 
    filter(scenario==scenario_value) %>%
    dplyr::select("zcta", "scenario", "ratio_diff", starts_with("value")) 
  
  #then link to sf and map
  mv = zcta_ca_geo_simplified %>% 
    left_join(df_measures, by = "zcta") %>% 
    mapview(
      col.regions= viridis_pal(option = "plasma", direction = 1),
      zcol = "value_cat",
      lwd=.75,
      layer.name = ratio_diff_value)
  
  return(mv)
}

```

# Scenario definitions

-   Tree canopy

    -   Population-based Scenario: AI: Increase by 10% in all zip codes

    -   Targeted

        -   Scenario AII1: Increase by 10% in zip codes in the lowest 1/5th of current TC cover (i.e. \<=20th pctile)

        -   Scenario AII2: Increase by 10% in zip codes in the highest 1/5th of the Social Vulnerability Index (i.e. \>80th pctile)

        -   Scenario AII3: Increase by 10% in zip codes in the highest 1/5th of hospitalization burden (i.e. \>80th pctile)

    -   Proportionate-universalism

        -   Scenario AIII1: Increase by 10% for bottom 1/5th of current TC cover... down to 2% for top 1/5th

        -   Scenario AIII2: Increase by 10% for top 1/5th of SVI ... down to 2% for bottom 1/5th

        -   Scenario AIII3: Increase by 10% for top 1/5th of hospitalization burden ... down to 2% for bottom 1/5th

-   Impervious surface cover

    -   Population-based: Scenario BI: Decrease by 10% in all zip codes

    -   Targeted

        -   Scenario BII1: Decrease by 10% in zip codes in the highest 1/5th of current imperv cover (i.e. \>80th pctile)

        -   Scenario BII2: Decrease by 10% in zip codes in the highest 1/5th of the Social Vulnerability Index (i.e. \>80th pctile)

        -   Scenario BII3: Decrease by 10% in zip codes in the highest 1/5th of hospitalization burden (i.e. \>80th pctile)

    -   Proportionate-universalism

        -   Scenario BIII1: Decrease by 10% for top 1/5th of current imperv cover ... down to 2% for bottom 1/5th

        -   Scenario BIII2: Decrease by 10% for top 1/5th of SVI ... down to 2% for bottom 1/5th

        -   Scenario BIII3: Decrease by 10% for top 1/5th of hospitalization burden ... down to 2% for bottom 1/5th



# Explore distribution of ratios and differences
```{r}
hosp_both_long %>% 
  filter(ratio_diff=="ratio") %>%
  dplyr::select(value) %>% 
  summary()

hosp_both_long %>% 
  filter(ratio_diff=="diff") %>%
  dplyr::select(value) %>% 
  summary()
```

# Visualization of scenarios
The following maps visualize, for each scenario, ratio-based and difference-based effect estimates on hospitalizations in California at the level of the zip-code tabulation area.


## Tree canopy
### Population-based Scenario: Increase by 10% in all zip codes
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% #note the aspatial data
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[1])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[1])
```

### Targeted Scenarios
#### Scenario AII1: Increase by 10% in zip codes in the lowest 1/5th of current TC cover (i.e. <=20th pctile) 
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[2])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[2])
```

#### Scenario AII2: Increase by 10% in zip codes in the highest 1/5th of the Social Vulnerability Index (i.e. >80th pctile)
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[3])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[3])
```

#### Scenario AII3: Increase by 10% in zip codes in the highest 1/5th of hospitalization burden (i.e. >80th pctile)
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[4])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[4])
```

### Proportinate-universalism Scenarios
#### Scenario AIII1: Increase by 10% for bottom 1/5th of current TC cover… down to 2% for top 1/5th
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[5])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[5])
```

#### Scenario AIII2: Increase by 10% for top 1/5th of SVI … down to 2% for bottom 1/5th
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[6])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[6])
```

#### Scenario AIII3: Increase by 10% for top 1/5th of hospitalization burden … down to 2% for bottom 1/5th
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[7])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[7])
```

## Impervious surface cover
### Population-based Scenario: Decrease by 10% in all zip codes
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[8])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[8])
```

### Targeted Scenarios
#### Scenario BII1: Decrease by 10% in zip codes in the highest 1/5th of current imperv cover (i.e. >80th pctile)
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[9])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[9])
```

#### Scenario BII2: Decrease by 10% in zip codes in the highest 1/5th of the Social Vulnerability Index (i.e. >80th pctile)
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[10])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[10])
```

#### Scenario BII3: Decrease by 10% in zip codes in the highest 1/5th of hospitalization burden (i.e. >80th pctile)
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[11])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[11])
```

### Proportionate-universalism
#### Scenario BIII1: Decrease by 10% for top 1/5th of current imperv cover … down to 2% for bottom 1/5th
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[12])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% 
  mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[12])
```

#### Scenario BIII2: Decrease by 10% for top 1/5th of SVI … down to 2% for bottom 1/5th 
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[13])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[13])
```

#### Scenario BIII3: Decrease by 10% for top 1/5th of hospitalization burden … down to 2% for bottom 1/5th
Ratio
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_ratio_long %>% 
  mv_fun(ratio_diff_value="ratio", scenario_value=scenario_list[14])
```

Difference
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
hosp_diff_long %>% mv_fun(ratio_diff_value="diff", scenario_value=scenario_list[14])
```
