---
title: "Hospitalization scenarios"
#author: "Michael Garber"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 4
    number_sections: FALSE
---

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#Load data and packages
#Feb 13 2022 update using long-form data.
library(here)
library(mapview)
library(tidyverse)
library(viridis)
library(viridisLite)
library(leaflet)
library(leaflet.extras)
library(tmap)
source(here("scripts","read-ratios-diffs-maren.R"))#load measures
source(here("scripts","link-zcta-hosp-data.R"))#load linked files

#Data created here:
#heat-hosp-california/scripts/link-zcta-hosp-data.R
```


# Scenario definitions

-   Tree canopy

    -   Population-based Scenario: AI: Increase by 10% in all zip codes

    -   Targeted

        -   Scenario AII1: Increase by 10% in zip codes in the lowest 1/5th of current TC cover (i.e. \<=20th pctile)

        -   Scenario AII2: Increase by 10% in zip codes in the highest 1/5th of the Social Vulnerability Index (i.e. \>80th pctile)

        -   Scenario AII3: Increase by 10% in zip codes in the highest 1/5th of hospitalization burden (i.e. \>80th pctile)

    -   Proportionate-universalism

        -   Scenario AIII1: Increase by 10% for bottom 1/5th of current TC cover... down to 2% for top 1/5th

        -   Scenario AIII2: Increase by 10% for top 1/5th of SVI ... down to 2% for bottom 1/5th

        -   Scenario AIII3: Increase by 10% for top 1/5th of hospitalization burden ... down to 2% for bottom 1/5th

-   Impervious surface cover

    -   Population-based: Scenario BI: Decrease by 10% in all zip codes

    -   Targeted

        -   Scenario BII1: Decrease by 10% in zip codes in the highest 1/5th of current imperv cover (i.e. \>80th pctile)

        -   Scenario BII2: Decrease by 10% in zip codes in the highest 1/5th of the Social Vulnerability Index (i.e. \>80th pctile)

        -   Scenario BII3: Decrease by 10% in zip codes in the highest 1/5th of hospitalization burden (i.e. \>80th pctile)

    -   Proportionate-universalism

        -   Scenario BIII1: Decrease by 10% for top 1/5th of current imperv cover ... down to 2% for bottom 1/5th

        -   Scenario BIII2: Decrease by 10% for top 1/5th of SVI ... down to 2% for bottom 1/5th

        -   Scenario BIII3: Decrease by 10% for top 1/5th of hospitalization burden ... down to 2% for bottom 1/5th



# Explore distribution of IRR, IRD, and perc. diff
Facet by type of intervention (impervious surfaces vs tree canopy) and by scenario type - Population-based, Proportionate Universalism, Targeted
```{r, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
facet_histogram_fun=function(df){
  df %>% 
      ggplot(aes(value))+
      geom_histogram()+
      facet_grid(
        rows=vars(scenario_type_7_abbrev),
        cols=vars(scenario_intervention)
      )
}
hosp_all_long %>% 
  filter(measure=="irr") %>%
  facet_histogram_fun()+
  xlab("IRR")

#All IRD
hosp_all_long %>% 
  filter(measure=="ird") %>%
  facet_histogram_fun()+
  xlab("IRD")

#Exclude outliers
hosp_all_long %>% 
  filter(measure=="ird") %>%
  filter(value<0.005) %>% 
  facet_histogram_fun()+
  xlab("IRD")


hosp_all_long %>% 
  filter(measure=="pd") %>%
  facet_histogram_fun()+
  xlab("PD")
```

# Static maps
Ideas for static maps of measures using facet plots

## Population-based scenarios: Impervious surfaces vs. Tree (IRR)
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
zcta_ca_geo_simplified %>% 
  left_join(hosp_irr_long, by = "zcta") %>% 
  filter(scenario_type_3 =="Population-based") %>% #excluding these
  ggplot()+
  geom_sf(
    aes(fill=value_cat),
    linewidth=.05)+
  scale_fill_viridis(
    direction=-1, #flip direction for ratios
    discrete=TRUE,
    name="IRR", #legend title
    na.value="grey")+
  #  theme_classic()+
  theme_minimal()+
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank()
  )+
  facet_grid(
    cols=vars(scenario_intervention)
  )
```


## Proportionate Universalism and Targeted Scenarios (IRR)
### Impervious Surfaces


```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot_facet_each_int_type_irr=function(df){
  df %>% 
  filter(scenario_type_3 !="Population-based") %>% #excluding these
  ggplot()+
  geom_sf(
    aes(fill=value_cat),
    linewidth=.05)+
  scale_fill_viridis(
    direction=-1, #flip direction for ratios
    discrete=TRUE,
    name="IRR", #legend title
    na.value="grey")+
#  theme_classic()+
  theme_minimal()+
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank()
    )+
  facet_grid(
    cols=vars(scenario_sub_type),
    rows=vars(scenario_type_3)
  )
  
}
zcta_ca_geo_simplified %>% 
  left_join(hosp_irr_long, by = "zcta") %>% 
  filter(scenario_intervention=="Imp") %>% 
  ggplot_facet_each_int_type_irr()

```

### Tree


```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
zcta_ca_geo_simplified %>% 
  left_join(hosp_irr_long, by = "zcta") %>% 
  filter(scenario_intervention=="Tree") %>% 
  ggplot_facet_each_int_type_irr()
```

# Interactive maps (IRR)

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#Define mapview functions
scenario_list = hosp_all_long %>% 
  distinct(scenario) %>% 
  pull()

#scenario_list[1]
#Set basemaps
mapviewOptions(
  basemaps = c("CartoDB.Positron","CartoDB.DarkMatter"))
map_fun = function(df, measure_value, scenario_value){
  #Feb 13 2023
  # I was having issues getting mapview to properly display the legend,
  #so I'm using tmap instead.

  df_measures= df %>% 
    filter(scenario==scenario_value) %>%
    dplyr::select("zcta", "scenario", "measure", starts_with("value")) 
  
  mapv_obj = zcta_ca_geo_simplified %>% 
    left_join(df_measures, by = "zcta") %>% 
    mapview(
      lwd=.1,
      layer.name=measure_value,
      col.regions = viridis_pal(),
      zcol = "value_cat")
    

  return(mapv_obj)
}

```

## Population-based: Imp vs Tree (side by side)
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(leaflet)
library(leafsync)

#tree
irr_tree_pb =  hosp_irr_long %>% 
  filter(scenario_intervention=="Tree") %>% 
  filter(scenario_type_7=="Pop. based") %>% 
  dplyr::select("zcta", starts_with("scenario"), "measure", starts_with("value")) 

mv_irr_tree_pb= zcta_ca_geo_simplified %>% 
  left_join(irr_tree_pb, by = "zcta") %>% 
  mapview(
    lwd=.1,
    layer.name="IRR (tree)",
    col.regions = viridis_pal(direction=-1),
    zcol = "value_cat")

#impervious surfaces
irr_imp_pb =  hosp_irr_long %>% 
  filter(scenario_intervention=="Imp") %>% 
  filter(scenario_type_7=="Pop. based") %>% 
  dplyr::select("zcta", starts_with("scenario"), "measure", starts_with("value")) 

mv_irr_imp_pb= zcta_ca_geo_simplified %>% 
  left_join(irr_imp_pb, by = "zcta") %>% 
  mapview(
    lwd=.1,
    layer.name="IRR (imp. surface)",
    col.regions = viridis_pal(direction=-1),
    zcol = "value_cat")

sync(mv_irr_imp_pb, mv_irr_tree_pb)
```

## Population-based: Imp vs Tree (separate layers)
Please navigate to the layer icon under the Zoom icon and select the layer corresponding to each type of intervention.
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
mv_irr_imp_pb+mv_irr_tree_pb
```

